<!DOCTYPE html>
<html lang="en">
  <head>
    <meta property="og:title" content="Nexus | Settings">
    <meta property="og:description" content="Edit your website settings here!">
    <meta property="og:image" content="/storage/images/logo.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings</title>
    <link rel="icon" href="../storage/images/googleclassroom.png" type="image/png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="/storage/css/settings.css" rel="stylesheet">
    <link href="/storage/css/style.css" rel="stylesheet">
    <script src="/storage/js/loading.js"></script>
  </head>
  <body>
    <script src="/storage/js/particles.js"></script>
    <script src="/storage/js/apps.js"></script>
    <div id="particles-js"></div>
    <div class="settings-container">
      <h1>Settings</h1>
      <label for="backgroundColorPicker">Select Background Color:</label>
      <input type="color" id="backgroundColorPicker">
      <div class="checkbox-container">
        <div>
          <label for="beforeUnloadToggle">Anti-Close</label>
          <input type="checkbox" id="beforeUnloadToggle" />
        </div>
        <div>
          <label for="autocloakToggle">Auto-about:blank</label>
          <input type="checkbox" id="autocloakToggle" />
        </div>
        <div>
          <label for="particlesToggle">Disable Particles</label>
          <input type="checkbox" id="particlesToggle" />
        </div>
      </div>
      <label for="username">Change your username</label>
      <input type="text" id="username" placeholder="John Doe" />
      <button id="saveusername">Save username</button>
      <hr>
      <label for="siteTitle">Set Site Title:</label>
      <input type="text" id="siteTitle" placeholder="Enter site title" />
      <label for="siteLogo">Set Site Favicon:</label>
      <input type="file" id="siteLogo" accept="image/*" />
      <button id="saveSettings">Save Title & Favicon</button>
      <hr>
      <label for="panicKey">Set Panic Button Key:</label>
      <input type="text" id="panicKey" placeholder="Enter key (e.g., F1)" />
      <label for="panicUrl">Set Panic Button URL:</label>
      <input type="text" id="panicUrl" placeholder="Enter URL to redirect to" />
      <button id="savePanicButtonSettings">Save Panic Button Settings</button>
      <hr>
      <button id="resetSettings" class="reset-button">Reset Tab Name and Icon</button>
      <button id="resetPanicButtonSettings" class="reset-button">Reset Panic Button Settings</button>
    </div>

    <script>
      const beforeUnloadToggle = document.getElementById('beforeUnloadToggle');
      const autocloakToggle = document.getElementById('autocloakToggle');
      const particlesToggle = document.getElementById('particlesToggle'); // added from old code
      const siteTitleInput = document.getElementById('siteTitle');
      const siteLogoInput = document.getElementById('siteLogo');
      const usernameInput = document.getElementById('username');
      const panicKeyInput = document.getElementById('panicKey');
      const panicUrlInput = document.getElementById('panicUrl');
      const saveSettingsButton = document.getElementById('saveSettings');
      const saveusernamebtn = document.getElementById('saveusername');
      const savePanicButtonSettingsButton = document.getElementById('savePanicButtonSettings');
      const resetSettingsButton = document.getElementById('resetSettings');
      const resetPanicButtonSettingsButton = document.getElementById('resetPanicButtonSettings');

      // Load saved states
      beforeUnloadToggle.checked = localStorage.getItem('beforeUnloadEnabled') === 'true';
      autocloakToggle.checked = localStorage.getItem('autocloakEnabled') === 'true';
      particlesToggle.checked = localStorage.getItem('particlesDisabled') === 'true';
      siteTitleInput.value = localStorage.getItem('siteTitle') || '';
      panicKeyInput.value = localStorage.getItem('panicKey') || '';
      panicUrlInput.value = localStorage.getItem('panicUrl') || '';
      usernameInput.value = localStorage.getItem('username') || '';

      // Apply favicon if saved
      const savedLogo = localStorage.getItem('siteLogo');
      if (savedLogo) {
        const faviconLink = document.createElement('link');
        faviconLink.rel = 'icon';
        faviconLink.href = savedLogo;
        document.head.appendChild(faviconLink);
      }

      // Apply particle visibility based on toggle
      document.getElementById('particles-js').style.display = particlesToggle.checked ? 'none' : '';

      // Save site title & favicon
      saveSettingsButton.addEventListener('click', function() {
        const siteTitle = siteTitleInput.value;
        const siteLogoFile = siteLogoInput.files[0];
        if (siteTitle) {
          localStorage.setItem('siteTitle', siteTitle);
          document.title = siteTitle;
        }
        if (siteLogoFile) {
          const reader = new FileReader();
          reader.onload = function(event) {
            const logoUrl = event.target.result;
            localStorage.setItem('siteLogo', logoUrl);
            const oldFavicon = document.querySelector("link[rel='icon']");
            if (oldFavicon) oldFavicon.remove();
            const faviconLink = document.createElement('link');
            faviconLink.rel = 'icon';
            faviconLink.href = logoUrl;
            document.head.appendChild(faviconLink);
          };
          reader.readAsDataURL(siteLogoFile);
        }
      });

      saveusernamebtn.addEventListener('click', function() {
        const newUsername = usernameInput.value;
        if (newUsername) {
          localStorage.setItem('username', newUsername);
        }
      });

      savePanicButtonSettingsButton.addEventListener('click', function() {
        const panicKey = panicKeyInput.value;
        const panicUrl = panicUrlInput.value;
        if (panicKey) localStorage.setItem('panicKey', panicKey);
        if (panicUrl) localStorage.setItem('panicUrl', panicUrl);
      });

      resetSettingsButton.addEventListener('click', function() {
        localStorage.removeItem('siteTitle');
        localStorage.removeItem('siteLogo');
        document.title = 'Home';
        const defaultFaviconLink = document.querySelector('link[rel="icon"]');
        if (defaultFaviconLink) {
          defaultFaviconLink.href = 'https://raw.githubusercontent.com/voucan/voucan.github.io/refs/heads/main/googleclassroom.png';
        }
      });

      resetPanicButtonSettingsButton.addEventListener('click', function() {
        localStorage.removeItem('panicKey');
        localStorage.removeItem('panicUrl');
      });

      beforeUnloadToggle.addEventListener('change', function() {
        localStorage.setItem('beforeUnloadEnabled', beforeUnloadToggle.checked);
        window.onbeforeunload = beforeUnloadToggle.checked ? () => '' : null;
      });

      if (beforeUnloadToggle.checked) {
        window.onbeforeunload = () => '';
      }

      autocloakToggle.addEventListener('change', function() {
        localStorage.setItem('autocloakEnabled', autocloakToggle.checked);
        if (autocloakToggle.checked) {
          const newTab = window.open('about:blank', '_blank');
          if (newTab) {
            const iframe = document.createElement('iframe');
            iframe.src = '/';
            iframe.style.cssText = 'width:100vw;height:100vh;border:none;';
            newTab.document.body.style.margin = '0';
            newTab.document.body.appendChild(iframe);
          }
          const panicUrl = localStorage.getItem('panicUrl') || 'https://example.com';
          window.location.href = panicUrl;
        }
      });

      // PARTICLES TOGGLE from old code
      particlesToggle.addEventListener('change', function() {
        localStorage.setItem('particlesDisabled', particlesToggle.checked);
        document.getElementById('particles-js').style.display = particlesToggle.checked ? 'none' : '';
      });
    </script>
  </body>
</html>
