<!DOCTYPE html>
<html lang="en">
<head>
  <meta property="og:title" content="Nexus | Roms">
  <meta property="og:description" content="Play your favorite roms!">
  <meta property="og:image" content="/storage/images/logo.png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Home</title>
  <link rel="icon" href="../storage/images/googleclassroom.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../storage/css/anotherstyle.css" />
  <link rel="stylesheet" href="../storage/css/style.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
</head>
<body>
  <script src="/particles.js"></script>
  <script src="/storage/js/app.js"></script>
  <div id="particles-js"></div>
  <div class="navbar">
    <div class="left-side">
      <a href="/"></a>
    </div>
    <div class="right-side">
      <script type="text/javascript" src="/storage/js/nav.js"></script>
    </div>
  </div>
  <div class="rom-title">Roms</div>
  <div class="roms-title" id="romsTitle">Select from 0 roms!</div>
  <div class="search-bar-container">
    <input
      type="text"
      id="romSearch"
      autocomplete="off"
      class="search-bar"
      placeholder="Search for a rom..."
      oninput="filterRoms()"
    />
    <button id="random-button">Let us pick</button>
  </div>
  <div class="rom-grid" id="romGrid"></div>

  <script>
    const CACHE_KEY = "roms-cache";
    const CACHE_TIME_KEY = "roms-cache-time";
    const JSON_PATH = "/storage/json/roms.json";

    async function loadRoms() {
      const cached = localStorage.getItem(CACHE_KEY);

      if (cached) {
        try {
          const roms = JSON.parse(cached);
          renderRoms(roms);
        } catch (e) {
          console.warn("Failed to parse cached roms:", e);
        }
      }

      try {
        const res = await fetch(JSON_PATH, { cache: "no-store" });
        if (!res.ok) throw new Error("Failed to fetch JSON");
        const freshRoms = await res.json();
        const freshString = JSON.stringify(freshRoms);
        if (freshString !== cached) {
          localStorage.setItem(CACHE_KEY, freshString);
          localStorage.setItem(CACHE_TIME_KEY, Date.now().toString());
          renderRoms(freshRoms);
        }
      } catch (err) {
        console.error(`Failed to fetch latest roms.json:`, err);
      }
    }

    function renderRoms(roms) {
      const romGrid = document.getElementById("romGrid");
      const romsTitle = document.getElementById("romsTitle");
      romGrid.innerHTML = "";

      for (const rom of roms) {
        const div = document.createElement("div");
        div.className = "rom-button";
        div.innerHTML = `
          <a href="${rom.url}">
            <img src="${rom.img}" alt="${rom.alt || rom.title}" onerror="this.onerror=null;this.src='/storage/images/404.png';" />
            <div class="overlay-text">${rom.title}</div>
          </a>
        `;
        romGrid.appendChild(div);
      }

      romsTitle.textContent = `Select from ${roms.length} roms!`;

      sortRomButtons();
      checkGridAlignment();
    }

    function filterRoms() {
      const searchInput = document.getElementById("romSearch").value.toLowerCase();
      const roms = document.querySelectorAll(".rom-button");
      roms.forEach((rom) => {
        const title = rom.querySelector(".overlay-text").textContent.toLowerCase();
        rom.style.display = title.includes(searchInput) ? "block" : "none";
      });
    }

    function checkGridAlignment() {
      const buttons = document.querySelectorAll(".rom-button");
      const pageWidth = window.innerWidth;
      buttons.forEach((button) => {
        const rect = button.getBoundingClientRect();
        const distanceToRightEdge = pageWidth - rect.right;
        button.style.clear = distanceToRightEdge < 75 ? "both" : "none";
      });
    }

    window.addEventListener("resize", checkGridAlignment);
    window.addEventListener("load", () => {
      loadRoms();
      checkGridAlignment();
    });

    document.getElementById("random-button").addEventListener("click", () => {
      const roms = Array.from(document.querySelectorAll(".rom-button a"));
      if (roms.length === 0) return;
      const randomIndex = Math.floor(Math.random() * roms.length);
      const randomRom = roms[randomIndex];
      window.location.href = randomRom.href;
    });
  </script>

  <script type="text/javascript" src="/storage/js/settings.js"></script>
  <script type="text/javascript" src="/storage/js/background.js"></script>
  <script type="text/javascript" src="/storage/js/resort.js"></script>
  <script type="text/javascript" src="/storage/js/cheese-algorithm.js"></script>
</body>
</html>
